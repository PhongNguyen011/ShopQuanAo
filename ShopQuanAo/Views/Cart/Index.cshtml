@model List<ShopQuanAo.Models.CartItem>
@using System.Globalization
@{
    ViewData["Title"] = "Giỏ hàng";
    var vn = CultureInfo.GetCultureInfo("vi-VN");
    decimal subtotal = ViewBag.Subtotal ?? (Model?.Sum(x => x.LineTotal) ?? 0M);
    string message = ViewBag.Message as string;

    // Stock map từ controller
    var stockMap = ViewBag.StockMap as Dictionary<int, int> ?? new Dictionary<int, int>();

    string VnMoney(decimal v) => string.Format(vn, "{0:N0} ₫", v);

    // Thông tin mã giảm giá
    var appliedCoupon = ViewBag.AppliedCoupon; // CartController đặt qua ViewBag (dynamic)
    decimal discount = ViewBag.Discount ?? 0M;
    decimal total = ViewBag.Total ?? (subtotal - discount);

    // Lấy chuỗi danh mục safe
    string allowedCats = "";
    if (appliedCoupon != null)
    {
        allowedCats = (appliedCoupon.AllowedCategoriesCsv as string) ?? "";
    }
}

@section Styles {
    <link href="~/css/cart.css" rel="stylesheet">
}

<div class="container">

    <!-- Breadcrumbs -->
    <div class="breadcrumbs d-flex flex-row align-items-center">
        <ul>
            <li><a asp-area="" asp-controller="Home" asp-action="Index">Trang Chủ</a></li>
            <li class="active"><a href="#"><i class="fa fa-angle-right" aria-hidden="true"></i> @ViewData["Title"]</a></li>
        </ul>
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div class="alert alert-success">@message</div>
    }

    @if (Model == null || Model.Count == 0)
    {
        <div class="empty-cart text-center py-5 bg-light border-1 rounded-4">
            <div class="display-6 mb-2">🧺</div>
            <p class="mb-3 text-muted">Giỏ hàng của bạn đang trống.</p>
            <a asp-controller="Product" asp-action="Index" class="btn btn-primary px-4">Đi mua sắm</a>
        </div>
    }
    else
    {
        <!-- form ẩn chỉ để lấy AntiForgery cho AJAX -->
        <form id="cart-anti" method="post">@Html.AntiForgeryToken()</form>

        <div class="row g-4">
            <!-- LEFT: Cart items -->
            <div class="col-lg-8">
                <div class="card border-1 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 d-flex align-items-center gap-2">
                            <i class="fa fa-shopping-cart"></i>
                            Có 
                            <span class="badge bg-dark rounded-pill">@Model.Count</span>
                            sản phẩm trong giỏ
                        </h6>
                    </div>

                    <div class="card-body p-0">
                        <div class="table-responsive cart-table">
                            <table class="table align-middle mb-0" id="cart-table">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:10%">Ảnh</th>
                                        <th style="width:25%">Sản phẩm</th>
                                        <th style="width:15%" class="text-end d-none d-md-table-cell">Đơn giá</th>
                                        <th style="width:25%" class="text-center">Số lượng</th>
                                        <th style="width:20%" class="text-end d-none d-md-table-cell">Thành tiền</th>
                                        <th style="width:5%"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        var img = (item.Image ?? "").Trim();
                                        var src = string.IsNullOrEmpty(img)
                                        ? Url.Content("~/images/_placeholder.png")
                                        : Url.Content($"{img}");
                                        var stock = stockMap.TryGetValue(item.ProductId, out var s) ? s : int.MaxValue;

                                        <tr id="row-@item.ProductId" data-id="@item.ProductId" data-stock="@stock">
                                            <td data-label="Ảnh">
                                                <img src="@src" alt="@item.Name"
                                                     style="width:70px;height:70px;object-fit:cover;border-radius:8px;" />
                                            </td>
                                            <td data-label="Sản phẩm">
                                                <div class="fw-semibold">@item.Name</div>
                                                <div class="small text-muted">
                                                    Tồn kho:
                                                    <span class="badge bg-@(stock == 0 ? "danger" : stock <= 5 ? "warning text-success" : "primary")">
                                                        <span id="stock-@item.ProductId">@stock</span>
                                                    </span>
                                                </div>
                                                <div class="d-md-none mt-1 small">
                                                    <span class="text-muted me-2">Đơn giá:</span>
                                                    <strong id="price-@item.ProductId">@VnMoney(item.Price)</strong>
                                                </div>
                                                <div class="d-md-none small">
                                                    <span class="text-muted me-2">Thành tiền:</span>
                                                    <strong id="line-@item.ProductId">@VnMoney(item.LineTotal)</strong>
                                                </div>
                                            </td>
                                            <td class="text-end d-none d-md-table-cell" id="price-@item.ProductId">@VnMoney(item.Price)</td>
                                            <td data-label="Số lượng">
                                                <div class="d-flex justify-content-center align-items-stretch gap-2" style="width:180px;margin:0 auto;">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm btn-minus" data-id="@item.ProductId" aria-label="Giảm">−</button>
                                                    <input type="text"
                                                           class="form-control form-control-sm text-center qty-input"
                                                           id="qty-@item.ProductId"
                                                           value="@item.Quantity"
                                                           readonly
                                                           inputmode="numeric"
                                                           style="width:80px;height:100%;" />
                                                    <button type="button" class="btn btn-outline-secondary btn-sm btn-plus" data-id="@item.ProductId" aria-label="Tăng">+</button>
                                                </div>
                                            </td>
                                            <td class="fw-semibold text-end d-none d-md-table-cell" id="line-@item.ProductId">@VnMoney(item.LineTotal)</td>
                                            <td data-label="Xoá">
                                                <form asp-action="Remove" method="post" class="m-0">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@item.ProductId" />
                                                    <button class="btn btn-danger btn-sm rounded" type="submit" title="Xoá">
                                                        <i class="fa fa-trash fs-5"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-end">Tạm tính</th>
                                        <th class="text-end" id="subtotal">@VnMoney(subtotal)</th>
                                        <th></th>
                                    </tr>
                                    <tr>
                                        <th colspan="4" class="text-end">Giảm</th>
                                        <th class="text-end" id="discount">@VnMoney(discount)</th>
                                        <th></th>
                                    </tr>
                                    <tr>
                                        <th colspan="4" class="text-end">Tổng</th>
                                        <th class="text-end fw-bold" id="total">@VnMoney(total)</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="card-footer bg-white d-flex flex-wrap justify-content-between gap-2 py-3">
                        <a asp-controller="Product" asp-action="Index" class="btn btn-outline-info rounded-pill">
                            <i class="fa fa-arrow-left me-1"></i>Tiếp tục mua sắm
                        </a>
                        <form asp-action="Clear" method="post" class="m-0">
                            @Html.AntiForgeryToken()
                            <button class="btn btn-outline-danger rounded-pill" type="submit">Xoá tất cả </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Summary -->
            <aside class="col-lg-4">
                <div class="card border-1 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h6 class="mb-0 d-flex align-items-center gap-2">
                            <i class="fa fa-receipt"></i> Tóm tắt & Mã giảm giá
                        </h6>
                    </div>

                    <div class="card-body">
                        <!-- KHỐI COUPON GIỮ NGUYÊN LOGIC -->
                        @if (appliedCoupon == null)
                        {
                            <form asp-action="ApplyCoupon" method="post" class="coupon-form" autocomplete="off">
                                @Html.AntiForgeryToken()
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fa fa-tag"></i></span>
                                    <input type="text" name="code" class="form-control coupon-input" placeholder="NHẬP MÃ (VD: SALE10)" />
                                    <button class="btn btn-primary">Áp dụng</button>
                                </div>
                                <div class="form-text mt-2">
                                    Có thể nhập nhiều mã, cách nhau dấu phẩy — hệ thống sẽ chọn mã tốt nhất.
                                </div>
                            </form>
                        }
                        else
                        {
                            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    <span class="badge rounded-pill bg-success px-3 py-2">
                                        <i class="fa fa-check-circle me-1"></i> Đã áp dụng
                                    </span>
                                    <span class="code-chip">@appliedCoupon.Code</span>
                                    <span class="text-muted small">
                                        — @(appliedCoupon.DiscountType == ShopQuanAo.Models.DiscountType.Percentage
                                                                        ? $"Giảm {appliedCoupon.DiscountValue}%"
                                                                        : $"Giảm {VnMoney((decimal)appliedCoupon.DiscountValue)}")
                            </span>
                        </div>
                        <form asp-action="RemoveCoupon" method="post" class="m-0">
                            @Html.AntiForgeryToken()
                            <button class="btn btn-outline-danger btn-sm">
                                <i class="fa fa-times me-1"></i> Bỏ mã
                            </button>
                        </form>
                    </div>

                            <div class="mt-2 small text-muted">
                        @if (appliedCoupon.MinOrderAmount != null)
                                {
                                    <div>• Đơn tối thiểu: <strong>@VnMoney((decimal)appliedCoupon.MinOrderAmount)</strong></div>
                                }
                                @if (appliedCoupon.Scope == ShopQuanAo.Models.CouponScope.CategoryOnly && !string.IsNullOrWhiteSpace(allowedCats))
                                {
                                    <div>• Phạm vi: chỉ áp dụng cho <strong>@allowedCats</strong></div>
                                }
                                <div>• Trạng thái: @(appliedCoupon.IsActive ? "Kích hoạt" : "Đã tắt")</div>
                            </div>
                        }

                        <!-- Totals (đồng bộ với tfoot qua event) -->
                        <ul class="list-group list-group-flush my-3">
                            <li class="list-group-item d-flex justify-content-between px-0">
                                <span class="text-muted">Tạm tính</span>
                                <span id="subtotal-card">@VnMoney(subtotal)</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between px-0">
                                <span class="text-muted">Giảm</span>
                                <span class="fw-semibold" id="discount-card">@VnMoney(discount)</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between px-0">
                                <span class="fw-semibold">Tổng thanh toán</span>
                                <span class="fw-bold fs-5" id="total-card">@VnMoney(total)</span>
                            </li>
                        </ul>

                        <div class="d-grid gap-2">
                            <a asp-controller="Checkout" asp-action="Index" class="btn btn-dark btn-lg">Thanh toán</a>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    }
</div>

@section Scripts {
    <script src="~/js/cart.js"></script>
}