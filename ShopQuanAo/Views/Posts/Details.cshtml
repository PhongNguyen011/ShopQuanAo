@model ShopQuanAo.Models.Post
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Http.Extensions
@{
    ViewData["Title"] = "Bài viết";
    var related = ViewBag.Related as List<ShopQuanAo.Models.Post> ?? new();
    string Img(string? f) => Url.Content(string.IsNullOrEmpty(f)
        ? "~/images/_placeholder.png"
        : $"~/images/posts/{f}");
    var isNew = (DateTime.Now - Model.CreatedAt).TotalDays <= 7;
}

@section Styles {
    <link href="~/css/details.css" rel="stylesheet">
}


<div class="container my-4">
    <!-- Breadcrumbs -->
    <div class="breadcrumbs d-flex flex-row align-items-center mb-3">
        <ul>
            <li><a asp-area="" asp-controller="Home" asp-action="Index">Trang Chủ</a></li>
            <li class="active">
                <a asp-controller="Posts" asp-action="Index">
                    <i class="fa fa-angle-right" aria-hidden="true"></i> @ViewData["Title"]
                </a>
            </li>
            <li class="active">
                <a><i class="fa fa-angle-right" aria-hidden="true"></i> Chi tiết @Model.Title</a>
            </li>
        </ul>
    </div>

    <!-- Bài viết chính -->
    <article class="post-wrap">
        <div class="row g-4 align-items-start">
            <!-- Ảnh bên trái -->
            <div class="col-md-5">
                @if (!string.IsNullOrEmpty(Model.Thumbnail))
                {
                    <a class="d-block post-thumb ratio ratio-4x3">
                        <img src="@Img(Model.Thumbnail)"
                             alt="@Model.Title"
                             loading="lazy"
                             decoding="async"
                             referrerpolicy="no-referrer" />
                    </a>
                }
            </div>

            <!-- Nội dung bên phải -->
            <div class="col-md-7">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <h3 class="post-title mb-0">@Model.Title</h3>
                    @if (isNew)
                    {
                        <span class="badge badge-new">Mới</span>
                    }
                </div>
                <div class="post-meta small mb-3">
                    <i class="fa fa-calendar-o me-1" aria-hidden="true"></i>
                    @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                    <span class="mx-2">•</span>
                    <span id="reading-time" class="text-muted"></span>
                </div>

                <div class="post-content mb-3">
                    @Html.Raw(Model.Content)
                </div>

                <div class="post-actions d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm px-3" id="copy-link">
                        <i class="fa fa-link me-1"></i> Sao chép liên kết
                    </button>
                    <button type="button" id="shareFacebook" class="btn btn-facebook btn-sm px-3">
                        <i class="fa fa-facebook me-1"></i> Chia sẻ Facebook
                    </button>
                </div>
            </div>
        </div>
    </article>

    <!-- Khoảng cách -->
    <hr class="my-4" />

    <!-- Bài viết khác -->
    <h5 class="mb-3">Bài viết khác</h5>
    <div class="row g-3">
        @foreach (var p in related)
        {
            <div class="col-12 col-sm-6 col-lg-3">
                <div class="rel-card h-100">
                    <a asp-controller="Posts" asp-action="Details" asp-route-slug="@p.Slug" class="d-block">
                        <img src="@Img(p.Thumbnail)" class="rel-thumb" alt="@p.Title" loading="lazy" decoding="async" />
                    </a>
                    <div class="p-3 position-relative">
                        <h6 class="rel-title mb-1">@p.Title</h6>
                        <div class="text-muted small">@p.CreatedAt.ToString("dd/MM/yyyy")</div>
                        <a asp-controller="Posts" asp-action="Details" asp-route-slug="@p.Slug" class="stretched-link" aria-label="@p.Title"></a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Ước lượng thời gian đọc (200 từ/phút)
        (function(){
            const el = document.querySelector('.post-content');
            const out = document.getElementById('reading-time');
            if (!el || !out) return;
            const text = el.innerText || el.textContent || "";
            const words = text.trim().split(/\s+/).filter(Boolean).length;
            const mins = Math.max(1, Math.round(words / 200));
            out.textContent = `${mins} phút đọc`;
        })();

        // Sao chép liên kết
        (function(){
            const btn = document.getElementById('copy-link');
            if (!btn || !navigator.clipboard) return;
            btn.addEventListener('click', async () => {
                try{
                    await navigator.clipboard.writeText(window.location.href);
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-success');
                    btn.innerHTML = '<i class="fa fa-check me-1"></i> Đã sao chép';
                    setTimeout(()=>{
                        btn.classList.add('btn-outline-secondary');
                        btn.classList.remove('btn-success');
                        btn.innerHTML = '<i class="fa fa-link me-1"></i> Sao chép liên kết';
                    }, 1800);
                }catch(e){ console.warn(e); }
            });
        })();

        // Chia sẻ Facebook (tự dán link bài viết hiện tại)
        (function(){
            const btn = document.getElementById('shareFacebook');
            if (!btn) return;
            btn.addEventListener('click', function(e){
                e.preventDefault();
                const currentUrl = window.location.href; // URL hiện tại
                const fbShareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`;
                window.open(
                    fbShareUrl,
                    'fb-share-dialog',
                    'width=700,height=500,menubar=no,toolbar=no,location=no,status=no'
                );
            });
        })();
    </script>
}

