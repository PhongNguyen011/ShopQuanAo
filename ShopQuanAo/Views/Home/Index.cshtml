@using ShopQuanAo.Data
@using ShopQuanAo.ViewModels
@inject ApplicationDbContext _context

@{
    ViewData["Title"] = "Trang Chủ";
    Layout = "_Layout";
}

@functions {
    string Slugify(string s)
    {
        s = s.Trim().ToLowerInvariant();
        s = System.Text.RegularExpressions.Regex.Replace(s, @"\s+", "-");
        s = System.Text.RegularExpressions.Regex.Replace(s, @"[^a-z0-9\-]", "");
        return s;
    }
    IEnumerable<string> SplitCats(string? s)
    {
        if (string.IsNullOrWhiteSpace(s)) yield break;
        foreach (var part in System.Text.RegularExpressions.Regex.Split(s, @"[,\|;/]+"))
        {
            var v = part.Trim();
            if (!string.IsNullOrEmpty(v)) yield return v;
        }
    }
    string ProdImg(string? url) => Url.Content(string.IsNullOrWhiteSpace(url)
        ? "~/images/product_1.png"
        : (url.StartsWith("~/") || url.StartsWith("/")) ? url : $"/images/products/{url}");

    string Img(string rel) => Url.Content($"~/images/{rel}");
    string SafeThumb(string? path) => Url.Content(string.IsNullOrWhiteSpace(path)
        ? "~/images/_placeholder.png"
        : (path!.StartsWith("~/") || path.StartsWith("/")) ? path : $"/images/posts/{path}");
}

@{
    // ===== SẢN PHẨM MỚI =====
    var newArrivals = _context.Products
        .Where(p => p.IsAvailable)
        .OrderByDescending(p => p.CreatedDate)
        .Take(24)
        .ToList();

    var allCategories = newArrivals
        .SelectMany(p => SplitCats(p.Category))
        .Distinct(StringComparer.OrdinalIgnoreCase)
        .OrderBy(c => c)
        .ToList();

    // ===== BÀI VIẾT GẦN ĐÂY =====
    var recentPosts = _context.Posts
        .OrderByDescending(p => p.CreatedAt)
        .Take(3)
        .ToList();

    // ===== SẢN PHẨM BÁN CHẠY (TOP 10) =====
    var bestSellersQuery =
        from oi in _context.OrderItems
        join o in _context.Orders on oi.OrderId equals o.Id
        join p in _context.Products on oi.ProductName equals p.Name
        where o.Status == "Delivered" && p.IsAvailable
        group new { oi, p } by new
        {
            p.Id,
            p.Name,
            p.ImageUrl,
            p.Price,
            p.OldPrice,
            p.Category,
            p.IsFeatured,
            p.IsOnSale
        }
        into g
        orderby g.Sum(x => x.oi.Quantity) descending
        select new BestSellerProductViewModel
        {
            ProductId = g.Key.Id,
            Name = g.Key.Name,
            ImageUrl = g.Key.ImageUrl,
            Price = g.Key.Price,
            OldPrice = g.Key.OldPrice,
            Category = g.Key.Category,
            IsAvailable = true,
            IsFeatured = g.Key.IsFeatured,
            IsOnSale = g.Key.IsOnSale,
            SoldQuantity = g.Sum(x => x.oi.Quantity),
            Revenue = g.Sum(x => x.oi.LineTotal)
        };

    var bestSellers = bestSellersQuery
        .Take(10)
        .ToList();
}

@section Styles {
    <link href="~/bootstrap4/bootstrap.min.css" rel="stylesheet">
    <link href="~/plugins/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="~/plugins/OwlCarousel2-2.2.1/owl.carousel.css" rel="stylesheet">
    <link href="~/plugins/OwlCarousel2-2.2.1/owl.theme.default.css" rel="stylesheet">
    <link href="~/plugins/OwlCarousel2-2.2.1/animate.css" rel="stylesheet">
    <link href="~/css/main_styles.css" rel="stylesheet">
}

<!-- ========== SLIDER TRÊN CÙNG ========== -->
<section id="heroCarousel" class="carousel slide" data-bs-ride="carousel">
    <div id="homeCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            @{
                var slides = _context.Slides.Where(s => s.IsActive).OrderBy(s => s.Id).ToList();
                var first = true;
            }
            @foreach (var slide in slides)
            {
                <div class="carousel-item @(first ? "active" : "")">
                    <img src="@Url.Content(slide.ImageUrl)" class="d-block w-100" alt="@slide.Title" />
                    <div class="carousel-caption d-none d-md-block">
                        <h5>@slide.Title</h5>
                        <p>@slide.Description</p>
                    </div>
                </div>
                first = false;
            }
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#homeCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#homeCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>
</section>

<!-- ========== 3 BANNER NHỎ ========== -->
<section class="banner-section py-5">
    <div class="container">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="banner_item align-items-center" style="background-image:url('@Img("banner_1.jpg")')">
                    <div class="banner_category">
                        <a href="@Url.Action("Index", "Product", new { category = "women" })">women's</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="banner_item align-items-center" style="background-image:url('@Img("banner_2.jpg")')">
                    <div class="banner_category">
                        <a href="@Url.Action("Index", "Product", new { category = "accessories" })">accessories</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="banner_item align-items-center" style="background-image:url('@Img("banner_3.jpg")')">
                    <div class="banner_category">
                        <a href="@Url.Action("Index", "Product", new { category = "men" })">men's</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- ========== SẢN PHẨM MỚI ========== -->
<div class="new_arrivals">
    <div class="container">
        <div class="row">
            <div class="col text-center">
                <div class="section_title new_arrivals_title">
                    <h2>Sản Phẩm Mới</h2>
                </div>
            </div>
        </div>
        <div class="row align-items-center">
            <div class="col text-center">
                <div class="new_arrivals_sorting">
                    <ul class="arrivals_grid_sorting clearfix button-group filters-button-group">
                        <li class="grid_sorting_button button d-flex flex-column justify-content-center align-items-center active is-checked" data-filter="*">all</li>
                        @foreach (var c in allCategories)
                        {
                            var slug = Slugify(c);
                            <li class="grid_sorting_button button d-flex flex-column justify-content-center align-items-center" data-filter=".@slug">@c</li>
                        }
                    </ul>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <div class="product-grid" data-isotope='{ "itemSelector": ".product-item", "layoutMode": "fitRows" }'>
                    @foreach (var product in newArrivals)
                    {
                        var catSlugs = SplitCats(product.Category).Select(Slugify).ToList();
                        var classStr = string.Join(" ", catSlugs);
                        var hasDiscount = product.IsOnSale && product.OldPrice.HasValue && product.OldPrice.Value > product.Price;
                        var discountPct = hasDiscount ? (int)Math.Round((product.OldPrice!.Value - product.Price) / product.OldPrice!.Value * 100) : 0;

                        <div class="product-item @classStr">
                            <div class="product @(hasDiscount ? "discount" : "") product_filter">
                                <div class="product_image">
                                    <a asp-controller="Product" asp-action="Detail" asp-route-id="@product.Id">
                                        <img src="@ProdImg(product.ImageUrl)" alt="@product.Name">
                                    </a>
                                </div>

                                @if (hasDiscount)
                                {
                                    <div class="product_bubble product_bubble_right product_bubble_red d-flex flex-column align-items-center">
                                        <span>-@discountPct%</span>
                                    </div>
                                }
                                else if (product.IsFeatured)
                                {
                                    <div class="product_bubble product_bubble_left product_bubble_green d-flex flex-column align-items-center">
                                        <span>new</span>
                                    </div>
                                }

                                <div class="product_info">
                                    <h6 class="product_name">
                                        <a asp-controller="Product" asp-action="Detail" asp-route-id="@product.Id">@product.Name</a>
                                    </h6>
                                    <div class="product_price">
                                        @product.Price.ToString("N0")đ
                                        @if (hasDiscount)
                                        {
                                            <span>@product.OldPrice!.Value.ToString("N0")đ</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            <div class="red_button add_to_cart_button">
                                <a asp-controller="Cart" asp-action="Add" asp-route-id="@product.Id" asp-route-qty="1">Thêm vào giỏ</a>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FLASH SALE HERO -->
<div class="container">
    @await Component.InvokeAsync("FlashSaleHero")
</div>

<!-- ========== BÁN CHẠY NHẤT (SLIDER DÙNG DỮ LIỆU THẬT) ========== -->
<div class="best_sellers">
    <div class="container">
        <div class="row">
            <div class="col text-center">
                <div class="section_title new_arrivals_title">
                    <h2>Bán Chạy Nhất</h2>
                </div>
            </div>
        </div>
    </div>

    @if (!bestSellers.Any())
    {
        <div class="container">
            <div class="alert alert-info mt-3">
                Chưa có dữ liệu đơn hàng (Delivered) để thống kê sản phẩm bán chạy.
            </div>
        </div>
    }
    else
    {
        <div class="container">
            <div class="row">
                <div class="col">
                    <div class="product_slider_container">
                        <div class="owl-carousel owl-theme product_slider">

                            @foreach (var item in bestSellers)
                            {
                                var hasDiscount = item.OldPrice.HasValue && item.OldPrice.Value > item.Price;
                                var discountPct = hasDiscount
                                ? (int)Math.Round((item.OldPrice.Value - item.Price) / item.OldPrice.Value * 100m)
                                : 0;

                                <div class="owl-item product_slider_item">
                                    <div class="product-item">
                                        <div class="product @(hasDiscount ? "discount" : "")">
                                            <div class="product_image">
                                                <a asp-controller="Product" asp-action="Detail" asp-route-id="@item.ProductId">
                                                    <img src="@ProdImg(item.ImageUrl)" alt="@item.Name">
                                                </a>
                                            </div>

                                            @if (hasDiscount)
                                            {
                                                <div class="product_bubble product_bubble_right product_bubble_red d-flex flex-column align-items-center">
                                                    <span>-@discountPct%</span>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="product_bubble product_bubble_left product_bubble_red d-flex flex-column align-items-center">
                                                    <span><i class="fa fa-fire"></i></span>
                                                </div>
                                            }

                                            <div class="product_info">
                                                <h6 class="product_name">
                                                    <a asp-controller="Product" asp-action="Detail" asp-route-id="@item.ProductId">@item.Name</a>
                                                </h6>
                                                <div class="product_price">
                                                    @item.Price.ToString("N0")đ
                                                    @if (hasDiscount)
                                                    {
                                                        <span>@item.OldPrice!.Value.ToString("N0")đ</span>
                                                    }
                                                </div>
                                                <div class="small text-muted mt-1">
                                                    Đã bán: <strong>@item.SoldQuantity</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="red_button add_to_cart_button">
                                            <a asp-controller="Cart" asp-action="Add"
                                               asp-route-id="@item.ProductId" asp-route-qty="1">
                                                Thêm vào giỏ
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            }

                        </div>

                        <div class="product_slider_nav_left product_slider_nav d-flex align-items-center justify-content-center flex-column">
                            <i class="fa fa-chevron-left" aria-hidden="true"></i>
                        </div>
                        <div class="product_slider_nav_right product_slider_nav d-flex align-items-center justify-content-center flex-column">
                            <i class="fa fa-chevron-right" aria-hidden="true"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- BENEFIT -->
<div class="benefit">
    <div class="container">
        <div class="row benefit_row">
            <div class="col-lg-3 benefit_col">
                <div class="benefit_item d-flex flex-row align-items-center">
                    <div class="benefit_icon"><i class="fa fa-truck" aria-hidden="true"></i></div>
                    <div class="benefit_content">
                        <h6>Miễn Phí Ship</h6>
                        <p>Ship Mọi Nơi Trên Toàn Quốc</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 benefit_col">
                <div class="benefit_item d-flex flex-row align-items-center">
                    <div class="benefit_icon"><i class="fa fa-money" aria-hidden="true"></i></div>
                    <div class="benefit_content">
                        <h6>Thanh Toán Online</h6>
                        <p>Thanh Toán Online Từ Mọi Nền Tảng</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 benefit_col">
                <div class="benefit_item d-flex flex-row align-items-center">
                    <div class="benefit_icon"><i class="fa fa-undo" aria-hidden="true"></i></div>
                    <div class="benefit_content">
                        <h6>45 Ngày Đổi Trả</h6>
                        <p>Nếu Sản Phẩm Không Đúng Ý!</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 benefit_col">
                <div class="benefit_item d-flex flex-row align-items-center">
                    <div class="benefit_icon"><i class="fa fa-clock-o" aria-hidden="true"></i></div>
                    <div class="benefit_content">
                        <h6>Thời Gian Mở Cửa</h6>
                        <p>8AM - 09PM</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BLOGS -->
<div class="blogs">
    <div class="container">
        <div class="row">
            <div class="col text-center">
                <div class="section_title">
                    <h2>Bài Viết Gần Đây</h2>
                </div>
            </div>
        </div>
        <div class="row blogs_container">
            @foreach (var p in recentPosts)
            {
                <div class="col-lg-4 blog_item_col">
                    <div class="blog_item">
                        <a class="d-block text-decoration-none"
                           href="@Url.Action("Details", "Posts", new { id = p.Id, slug = p.Slug })"
                           title="@p.Title">
                            <div class="blog_background" style="background-image:url('@SafeThumb(p.Thumbnail)')"></div>
                            <div class="blog_content d-flex flex-column align-items-center justify-content-center text-center">
                                <h4 class="blog_title">@p.Title</h4>
                                <span class="blog_meta">by admin | @p.CreatedAt.ToString("MMM dd, yyyy").ToLower()</span>
                                <span class="blog_more">Read more</span>
                            </div>
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/jquery-3.2.1.min.js"></script>
    <script src="~/styles/bootstrap4/popper.js"></script>
    <script src="~/styles/bootstrap4/bootstrap.min.js"></script>
    <script src="~/plugins/Isotope/isotope.pkgd.min.js"></script>
    <script src="~/plugins/OwlCarousel2-2.2.1/owl.carousel.js"></script>
    <script src="~/plugins/easing/easing.js"></script>
    <script src="~/js/custom.js"></script>
}
